# Firewall Detection Techniques

### What is Firewall ?

A firewall is a software or hardware device that inspects incoming and outgoing traffic on a network. Based on a predetermined set of policies and rules, or an access control list \(ACL\), the firewall filters and restricts all connections that do not abide by those rules. The main purpose of a firewall is to separate trusted networks from the external network or the internet.

![](../assets/1_firewll.jpg)

One helpful feature of the TCP protocol is that systems are required by [RFC 793](http://www.rfc-editor.org/rfc/rfc793.txt) to send a negative response to unexpected connection requests in the form of a TCP RST \(reset\) packet. The RST packet makes closed ports easy for Nmap to recognize. Filtering devices such as firewalls, on the other hand, tend to drop packets destined for disallowed ports. In some cases they send ICMP error messages \(usually port unreachable\) instead. Because dropped packets and ICMP errors are easily distinguishable from RST packets, Nmap can reliably detect filtered TCP ports from open or closed ones, and it does so automatically

## Firewall identification with Nmap

Nmap has a streamlined firewall filtering identification function that can be used to identify filtering on ports based on ACK probe responses. This function can be used to test a single port or multiple ports in sequence to determine filtering status.

To use Nmap to perform firewall identification, we will need to have a remote system that is running network services.

**These steps help to identify firewall using nmap:**

* To perform an Nmap firewall ACK scan, nmap should be called with the IP address specification, the destination port, and the -sA option:

```text
nmap -sA <ip> -p <port>
```

![](../assets/1_with_nmap.png)

* On performing this scan on the Metasploitable2 system in my local network without routing the traffic through a firewall, the response indicates that the TCP port 22 \(SSH\) is unfiltered. A port-filtering assessment can be made on Nmap's 1,000 common ports by performing the same scan without providing a port specification:

![](../assets/2_with_nmap.png)

* When performed against the Metasploitable2 system on the local network that is not sitting behind any firewall, the results indicate that all scanned ports are unfiltered. If the same scan is performed against a target sitting behind a packet-filtering firewall, all ports are identified to be filtered except for ports where the firewall does not restrict traffic. When scanning a range of ports, the output only includes unfiltered ports.

![](../assets/3_with_nmap.png)

#### How it works ?

Combination of SYN and unsolicited ACK packets are sent to the destination port, and the responses are analyzed to determine the state of filtering.

## Firewall identification with Metasploit

Metasploit has a scanning auxiliary module that can be used to perform multithreaded analysis of network ports to determine whether those ports are filtered, based on SYN/ACK probe-response analysis.

To use Nmap to perform firewall identification, we will need to have a remote system that is running network services.

**These steps help to identify firewall using metasploit:**

* To use Metasploit ACK scan module, launch MSF console and select auxiliary module with the use command.

```text
msf > use auxiliary/scanner/portscan/ack
```

![](../assets/1_firewall_metasploit.png)

* The `show options` command can be used to identify and/or modify scan configurations.
* Value of the variable can be changed using `set command`

![](../assets/2_firewall_metasploit.png)

This lack of output is due to the fact that the responses associated with the SYN and ACK injections were exactly the same from port to port because the Metasploitable2 system that was being scanned is not behind any firewall.

#### How it works ?

Metasploit offers an auxiliary module that performs firewall identification. Metasploit also offers the capability to perform this analysis within the context of a framework that can be used for other information gathering, and even exploitation.

